<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <!-- iOS Fullscreen -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />
  <title>Constelaciones AR - Calibración Mejorada</title>
  <style>
    /* Fuente y reset */
    @font-face {
      font-family: 'Avenir';
      src: local('Avenir'), local('AvenirLTStd-Book');
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      overflow: hidden;
      background: #000;
      font-family: 'Avenir', sans-serif;
      color: #fff;
      touch-action: none;
      height: 100vh;
    }
    /* Fondo cósmico y video */
    #video {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: 1;
    }
    #starfield {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 2;
      pointer-events: none;
      background: linear-gradient(120deg, #01010f, #090921, #0f0c29);
      background-size: 200% 200%;
      animation: cosmicGradient 25s ease infinite;
      opacity: 0.7;
    }
    @keyframes cosmicGradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    #skyCanvas {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 3;
      pointer-events: none;
    }
    /* Estilos para estrellas y retícula central */
    .star {
      position: absolute;
      border-radius: 50%;
      background-color: #fff;
      box-shadow: 0 0 2px rgba(255,255,255,0.8);
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 4;
    }
    .star.bright {
      box-shadow: 0 0 12px 2px rgba(255,255,255,0.7);
    }
    .center-reticle {
      position: fixed;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      width: 40px; height: 40px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      pointer-events: none;
      z-index: 20;
    }
    .center-reticle::before, .center-reticle::after {
      content: "";
      position: absolute;
      background: rgba(255,255,255,0.3);
    }
    .center-reticle::before {
      width: 2px; height: 100%;
      left: 50%; transform: translateX(-50%);
    }
    .center-reticle::after {
      width: 100%; height: 2px;
      top: 50%; transform: translateY(-50%);
    }
    /* Paneles (inicio, calibración, controles, sensibilidad) */
    #startPanel, #calibrationUI, #sensibilityPanel, #orientationWarning, #objectInfo {
      position: fixed;
      z-index: 50;
      background: rgba(13,27,42,0.7);
      color: #fff;
      font-family: 'Avenir', sans-serif;
    }
    #startPanel {
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #01010f, #2a002b);
      background-size: 400% 400%;
      animation: cosmicGradient 15s ease infinite;
    }
    #startPanel h1 { margin-bottom: 30px; font-size: 28px; color: #fff; text-shadow: 0 2px 10px rgba(100,181,246,0.5); font-weight: 600; }
    #startPanel p { margin-bottom: 20px; color: #eee; font-size: 16px; }
    #startPanel button {
      padding: 12px 30px;
      background: linear-gradient(135deg, #2962ff, #0039cb);
      color: #fff;
      border: none;
      border-radius: 30px;
      font-size: 18px;
      box-shadow: 0 4px 15px rgba(41,98,255,0.4);
      margin: 5px;
      cursor: pointer;
    }
    #controls {
      bottom: 20px; left: 0; width: 100%;
      display: flex; justify-content: center; gap: 10px;
      pointer-events: auto;
      z-index: 10;
    }
    .btn {
      padding: 10px 20px;
      background: rgba(13,27,42,0.7);
      color: #fff;
      border: 1px solid rgba(100,149,237,0.4);
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      font-family: 'Avenir', sans-serif;
    }
    .btn:hover { background: rgba(40,63,83,0.8); }
    #calibrationUI {
      top: 0; left: 0; width: 100%; height: 100%;
      display: none; flex-direction: column;
      justify-content: center; align-items: center;
      text-align: center;
      padding: 20px;
    }
    #calibrationUI h2 { margin-bottom: 20px; font-size: 24px; font-weight: 600; }
    #calibrationUI p { margin-bottom: 30px; max-width: 80%; color: #ddd; }
    #calibrationIndicator {
      width: 200px; height: 200px;
      border-radius: 50%; border: 2px solid #82b1ff;
      position: relative; margin-bottom: 40px;
    }
    #calibrationDot {
      width: 20px; height: 20px;
      background-color: #2962ff; border-radius: 50%;
      position: absolute; left: 50%; top: 50%;
      transform: translate(-50%,-50%);
      box-shadow: 0 0 10px rgba(41,98,255,0.7);
    }
    #confirmCalibration {
      padding: 10px 20px;
      background: #2962ff;
      color: #fff;
      border: none;
      border-radius: 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #calibMsg { margin-top: 10px; color: #ccc; font-size: 13px; }
    /* Advertencia de orientación */
    #orientationWarning {
      top: 0; left: 0; width: 100%; height: 100%;
      display: none; flex-direction: column;
      justify-content: center; align-items: center;
      background: rgba(0,0,0,0.9);
      text-align: center; padding: 20px;
      z-index: 150;
    }
    #orientationWarning p { color: white; font-size: 18px; max-width: 80%; }
    /* Panel de sensibilidad */
    #sensibilityPanel {
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      border: 1px solid rgba(100,149,237,0.4);
      border-radius: 12px;
      padding: 20px;
      width: 300px;
      background: rgba(13,27,42,0.9);
      z-index: 90;
      display: none;
    }
    #sensibilityPanel h3 { margin-bottom: 15px; color: #82b1ff; font-size: 18px; text-align: center; }
    .slider-container { margin-bottom: 15px; }
    .slider-container label { display: block; margin-bottom: 5px; font-size: 14px; color: #eee; }
    .slider-container input { width: 100%; }
    .value-display { display: flex; justify-content: space-between; font-size: 12px; color: #ccc; }
    #sensibilityPanel button {
      background: #2962ff;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 15px;
      margin-top: 10px;
      width: 100%;
      cursor: pointer;
    }
    #sensibilityPanel button:hover { background: #1c47a8; }
  </style>
</head>
<body>
  <!-- Cámara -->
  <video id="video" playsinline muted></video>
  <!-- Fondo cósmico -->
  <div id="starfield"></div>
  <!-- Canvas para líneas -->
  <canvas id="skyCanvas"></canvas>
  <!-- Retícula central -->
  <div class="center-reticle"></div>
  <!-- Controles -->
  <div id="controls">
    <button id="calibrateBtn" class="btn">Calibrar</button>
    <button id="sensibilityBtn" class="btn">Sensibilidad</button>
    <button id="resetBtn" class="btn">Reiniciar</button>
    <button id="debugToggleBtn" class="btn">Debug</button>
  </div>
  <!-- Panel de información -->
  <div id="objectInfo" style="display: none; bottom: 80px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 10px; max-width: 80%; text-align: center; backdrop-filter: blur(5px); border: 1px solid rgba(100,149,237,0.4);">
    <h3 id="objectName"></h3>
    <p id="objectDesc"></p>
  </div>
  <!-- Panel de inicio -->
  <div id="startPanel">
    <h1>Constelaciones AR</h1>
    <p>
      Usa la app en modo vertical.<br/>
      Primero, haz clic en <strong>Request Permissions</strong>.<br/>
      Luego haz clic en <strong>Start</strong> para comenzar.
    </p>
    <button id="requestPermissionBtn">Request Permissions</button>
    <button id="startBtn" disabled>Start</button>
  </div>
  <!-- Panel de calibración mejorada -->
  <div id="calibrationUI">
    <h2>Calibración</h2>
    <p>
      Apunta tu iPhone hacia adelante y alinea el punto azul con el centro.<br/>
      Mantén el dispositivo quieto para tomar muestras y luego haz clic en Confirm.
    </p>
    <div id="calibrationIndicator">
      <div id="calibrationDot"></div>
    </div>
    <button id="confirmCalibration">Confirm</button>
    <p id="calibMsg"></p>
  </div>
  <!-- Panel de sensibilidad -->
  <div id="sensibilityPanel">
    <h3>Ajustes de Sensibilidad</h3>
    <div class="slider-container">
      <label for="horizSensSlider">Sensibilidad Horizontal:</label>
      <input type="range" min="0.5" max="5" step="0.1" value="1.0" id="horizSensSlider">
      <div class="value-display">
        <span>Baja</span>
        <span id="horizSensValue">1.0</span>
        <span>Alta</span>
      </div>
    </div>
    <div class="slider-container">
      <label for="vertSensSlider">Sensibilidad Vertical:</label>
      <input type="range" min="0.5" max="5" step="0.1" value="1.0" id="vertSensSlider">
      <div class="value-display">
        <span>Baja</span>
        <span id="vertSensValue">1.0</span>
        <span>Alta</span>
      </div>
    </div>
    <div class="slider-container">
      <label for="smoothingSlider">Suavizado:</label>
      <input type="range" min="0" max="0.95" step="0.05" value="0.7" id="smoothingSlider">
      <div class="value-display">
        <span>Ninguno</span>
        <span id="smoothingValue">0.7</span>
        <span>Máximo</span>
      </div>
    </div>
    <div class="slider-container">
      <label for="invertXSlider">Invertir Eje X:</label>
      <input type="checkbox" id="invertXSlider">
    </div>
    <div class="slider-container">
      <label for="invertYSlider">Invertir Eje Y:</label>
      <input type="checkbox" id="invertYSlider">
    </div>
    <button id="closeSettingsBtn">Guardar Cambios</button>
  </div>
  <!-- Advertencia de orientación -->
  <div id="orientationWarning">
    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
      <path d="M17 2H7C5.9 2 5 2.9 5 4V20C5 21.1 5.9 22 7 22H17C18.1 22 19 21.1 19 20V4C19 2.9 18.1 2 17 2Z"></path>
      <path d="M12 18H12.01"></path>
      <path d="M7 7H17"></path>
      <path d="M7 12H17"></path>
    </svg>
    <p>Por favor rota tu dispositivo a modo retrato para la mejor experiencia</p>
  </div>
  <!-- Debug info -->
  <div id="debug" style="position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 5px; border-radius: 5px; font-size: 10px; max-width: 50%; display: none; white-space: pre; font-family: 'Avenir', sans-serif;"></div>

  <!-- CARGA DE GYRONORM Y FULLTILT (se usa para gestionar la orientación) -->
  <script>
    // GyroNorm.js v2.0.6 (minificado)
    !function(a,b){"function"==typeof define&&define.amd?define(function(){return b()}):"object"==typeof exports?module.exports=b():a.GyroNorm=b()}(this,function(){function a(a){return Math.round(a*Math.pow(10,t))/Math.pow(10,t)}function b(){var b={};b=v?o.getScreenAdjustedEuler():o.getFixedFrameEuler();var c=p.getScreenAdjustedAcceleration(),e=p.getScreenAdjustedAccelerationIncludingGravity(),f=p.getScreenAdjustedRotationRate(),g=0;s===d?(g=b.alpha-k,g=0>g?360-Math.abs(g):g):g=b.alpha;var h={do:{alpha:a(g),beta:a(b.beta),gamma:a(b.gamma),absolute:o.isAbsolute()},dm:{x:a(c.x),y:a(c.y),z:a(c.z),gx:a(e.x),gy:a(e.y),gz:a(e.z),alpha:a(f.alpha||0),beta:a(f.beta||0),gamma:a(f.gamma||0)}};return r&&(h.dm.gx*=q,h.dm.gy*=q,h.dm.gz*=q),h}function c(a){u&&("string"==typeof a&&(a={message:a,code:0}),u(a))}var d="game",e="world",f="deviceorientation",g="acceleration",h="accelerationinludinggravity",i="rotationrate",j=null,k=0,l=null,m=null,n=null,o=null,p=null,q=0,r=!1,s=d,t=2,u=null,v=!1,w=function(a){};return w.GAME=d,w.WORLD=e,w.DEVICE_ORIENTATION=f,w.ACCELERATION=g,w.ACCELERATION_INCLUDING_GRAVITY=h,w.ROTATION_RATE=i,w.prototype.init=function(a){a&&a.frequency&&(l=a.frequency),a&&a.gravityNormalized&&(r=a.gravityNormalized),a&&a.orientationBase&&(s=a.orientationBase),a&&"number"==typeof a.decimalCount&&a.decimalCount>=0&&(t=a.decimalCount),a&&a.logger&&(u=a.logger),a&&a.screenAdjusted&&(v=a.screenAdjusted);var b=new FULLTILT.getDeviceOrientation({type:s}).then(function(a){o=a}),c=(new FULLTILT.getDeviceMotion).then(function(a){p=a,r&&(q=p.getScreenAdjustedAccelerationIncludingGravity().z>0?-1:1)});return Promise.all([b,c]).then(function(){n=!0})},w.prototype.end=function(){try{n=!1,this.stop(),p.stop(),o.stop()}catch(a){c(a)}},w.prototype.start=function(a){return n?(j=a,m||(o.start(),p.start(),m=setInterval(function(){j(b())},l)),!0):(c({message:'GyroNorm is not initialized yet. First call the "init()" function.',code:1}),!1)},w.prototype.stop=function(){j=null,m&&(clearInterval(m),m=null)},w.prototype.normalizeGravity=function(a){r=a,p&&(q=p.getScreenAdjustedAccelerationIncludingGravity().z>0?-1:1)},w.prototype.setHeadDirection=function(){return v||s!==d?!1:(k=o.getFixedFrameEuler().alpha,!0)},w.prototype.startLogging=function(a){a&&(u=a)},w.prototype.stopLogging=function(){u=null},w.prototype.isAvailable=function(a){var b=o.getScreenAdjustedEuler(),c=p.getScreenAdjustedAcceleration(),d=p.getScreenAdjustedAccelerationIncludingGravity(),e=p.getScreenAdjustedRotationRate();switch(a){case f:return b.alpha&&null!==b.alpha&&b.beta&&null!==b.beta&&b.gamma&&null!==b.gamma;case g:return c&&c.x&&c.y&&c.z;case h:return d&&d.x&&d.y&&d.z;case i:return e&&e.alpha&&e.beta&&e.gamma;default:return!1}},w.prototype.isRunning=function(){return null!==m},w});
    
    // FULLTILT (versión simplificada)
    (function(window){
      var FULLTILT = {};
      var DEGREE_TO_RADIAN = Math.PI / 180;
      var RADIAN_TO_DEGREE = 180 / Math.PI;
      var quaternionMultiply = function(a, b) {
        var w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;
        var x = a.w * b.x + a.x * b.w + a.y * b.z - a.z * b.y;
        var y = a.w * b.y - a.x * b.z + a.y * b.w + a.z * b.x;
        var z = a.w * b.z + a.x * b.y - a.y * b.x + a.z * b.w;
        return { w: w, x: x, y: y, z: z };
      };
      var eulerToQuaternion = function(euler) {
        var roll = euler.gamma * DEGREE_TO_RADIAN;
        var pitch = euler.beta * DEGREE_TO_RADIAN;
        var yaw = euler.alpha * DEGREE_TO_RADIAN;
        var cX = Math.cos(pitch / 2), cY = Math.cos(yaw / 2), cZ = Math.cos(roll / 2);
        var sX = Math.sin(pitch / 2), sY = Math.sin(yaw / 2), sZ = Math.sin(roll / 2);
        var w = cX * cY * cZ - sX * sY * sZ;
        var x = sX * cY * cZ - cX * sY * sZ;
        var y = cX * sY * cZ + sX * cY * sZ;
        var z = cX * cY * sZ + sX * sY * cZ;
        return { w: w, x: x, y: y, z: z };
      };
      var quaternionToEuler = function(q) {
        var ysqr = q.y * q.y;
        var t0 = 2.0 * (q.w * q.x + q.y * q.z);
        var t1 = 1.0 - 2.0 * (q.x * q.x + ysqr);
        var roll = Math.atan2(t0, t1) * RADIAN_TO_DEGREE;
        var t2 = 2.0 * (q.w * q.y - q.z * q.x);
        t2 = t2 > 1.0 ? 1.0 : t2;
        t2 = t2 < -1.0 ? -1.0 : t2;
        var pitch = Math.asin(t2) * RADIAN_TO_DEGREE;
        var t3 = 2.0 * (q.w * q.z + q.x * q.y);
        var t4 = 1.0 - 2.0 * (ysqr + q.z * q.z);
        var yaw = Math.atan2(t3, t4) * RADIAN_TO_DEGREE;
        return { alpha: yaw, beta: pitch, gamma: roll };
      };
      var DeviceOrientation = function() {
        this.eulerAngles = { alpha: 0, beta: 0, gamma: 0 };
        this._isAbsolute = false;
        this._isRunning = false;
        this._handler = null;
      };
      DeviceOrientation.prototype = {
        start: function() {
          if (this._isRunning) return;
          var self = this;
          this._handler = function(event) {
            self.eulerAngles.alpha = event.alpha || 0;
            self.eulerAngles.beta = event.beta || 0;
            self.eulerAngles.gamma = event.gamma || 0;
            self._isAbsolute = event.absolute || false;
          };
          window.addEventListener('deviceorientation', this._handler, false);
          this._isRunning = true;
        },
        stop: function() {
          if (!this._isRunning) return;
          window.removeEventListener('deviceorientation', this._handler, false);
          this._isRunning = false;
        },
        getFixedFrameEuler: function() {
          return { alpha: this.eulerAngles.alpha, beta: this.eulerAngles.beta, gamma: this.eulerAngles.gamma };
        },
        getScreenAdjustedEuler: function() {
          var orientationAngle = window.orientation || 0;
          var adjustedEuler = { alpha: this.eulerAngles.alpha, beta: this.eulerAngles.beta, gamma: this.eulerAngles.gamma };
          if (orientationAngle) {
            var quaternion = eulerToQuaternion(this.eulerAngles);
            var screenQuaternion = { w: 1, x: 0, y: 0, z: 0 };
            if (orientationAngle === 90) {
              screenQuaternion = { w: 0.7071, x: 0, y: 0, z: -0.7071 };
            } else if (orientationAngle === -90) {
              screenQuaternion = { w: 0.7071, x: 0, y: 0, z: 0.7071 };
            } else if (orientationAngle === 180) {
              screenQuaternion = { w: 0, x: 0, y: 1, z: 0 };
            }
            var adjustedQuaternion = quaternionMultiply(screenQuaternion, quaternion);
            adjustedEuler = quaternionToEuler(adjustedQuaternion);
          }
          return adjustedEuler;
        },
        isAbsolute: function() { return this._isAbsolute; }
      };
      var DeviceMotion = function() {
        this.acceleration = { x: 0, y: 0, z: 0 };
        this.accelerationIncludingGravity = { x: 0, y: 0, z: 0 };
        this.rotationRate = { alpha: 0, beta: 0, gamma: 0 };
        this._isRunning = false;
        this._handler = null;
      };
      DeviceMotion.prototype = {
        start: function() {
          if (this._isRunning) return;
          var self = this;
          this._handler = function(event) {
            if (event.acceleration) {
              self.acceleration.x = event.acceleration.x || 0;
              self.acceleration.y = event.acceleration.y || 0;
              self.acceleration.z = event.acceleration.z || 0;
            }
            if (event.accelerationIncludingGravity) {
              self.accelerationIncludingGravity.x = event.accelerationIncludingGravity.x || 0;
              self.accelerationIncludingGravity.y = event.accelerationIncludingGravity.y || 0;
              self.accelerationIncludingGravity.z = event.accelerationIncludingGravity.z || 0;
            }
            if (event.rotationRate) {
              self.rotationRate.alpha = event.rotationRate.alpha || 0;
              self.rotationRate.beta = event.rotationRate.beta || 0;
              self.rotationRate.gamma = event.rotationRate.gamma || 0;
            }
          };
          window.addEventListener('devicemotion', this._handler, false);
          this._isRunning = true;
        },
        stop: function() {
          if (!this._isRunning) return;
          window.removeEventListener('devicemotion', this._handler, false);
          this._isRunning = false;
        },
        getScreenAdjustedAcceleration: function() {
          var orientationAngle = window.orientation || 0;
          var accel = { x: this.acceleration.x, y: this.acceleration.y, z: this.acceleration.z };
          if (orientationAngle === 90) {
            accel = { x: this.acceleration.y, y: -this.acceleration.x, z: this.acceleration.z };
          } else if (orientationAngle === -90) {
            accel = { x: -this.acceleration.y, y: this.acceleration.x, z: this.acceleration.z };
          } else if (orientationAngle === 180) {
            accel = { x: -this.acceleration.x, y: -this.acceleration.y, z: this.acceleration.z };
          }
          return accel;
        },
        getScreenAdjustedAccelerationIncludingGravity: function() {
          var orientationAngle = window.orientation || 0;
          var accel = { x: this.accelerationIncludingGravity.x, y: this.accelerationIncludingGravity.y, z: this.accelerationIncludingGravity.z };
          if (orientationAngle === 90) {
            accel = { x: this.accelerationIncludingGravity.y, y: -this.accelerationIncludingGravity.x, z: this.accelerationIncludingGravity.z };
          } else if (orientationAngle === -90) {
            accel = { x: -this.accelerationIncludingGravity.y, y: this.accelerationIncludingGravity.x, z: this.accelerationIncludingGravity.z };
          } else if (orientationAngle === 180) {
            accel = { x: -this.accelerationIncludingGravity.x, y: -this.accelerationIncludingGravity.y, z: this.accelerationIncludingGravity.z };
          }
          return accel;
        },
        getScreenAdjustedRotationRate: function() {
          var orientationAngle = window.orientation || 0;
          var rate = { alpha: this.rotationRate.alpha, beta: this.rotationRate.beta, gamma: this.rotationRate.gamma };
          if (orientationAngle === 90) {
            rate = { alpha: this.rotationRate.alpha, beta: this.rotationRate.gamma, gamma: -this.rotationRate.beta };
          } else if (orientationAngle === -90) {
            rate = { alpha: this.rotationRate.alpha, beta: -this.rotationRate.gamma, gamma: this.rotationRate.beta };
          } else if (orientationAngle === 180) {
            rate = { alpha: this.rotationRate.alpha, beta: -this.rotationRate.beta, gamma: -this.rotationRate.gamma };
          }
          return rate;
        }
      };
      FULLTILT.getDeviceOrientation = function(options) {
        return new Promise(function(resolve) {
          var instance = new DeviceOrientation();
          resolve(instance);
        });
      };
      FULLTILT.getDeviceMotion = function() {
        return new Promise(function(resolve) {
          var instance = new DeviceMotion();
          resolve(instance);
        });
      };
      window.FULLTILT = FULLTILT;
    })(window);
  </script>

  <script>
    // Variables de estado
    let appActive = false;
    let calibrating = false;
    let stream = null;
    let showDebug = false;
    let lastOrientationUpdate = Date.now();
    let fallbackOrientation = { alpha: 0, beta: 0, gamma: 0 };
    let gn = null; // Instancia de GyroNorm

    // Ajustes de sensibilidad
    let smoothingFactor = 0.7;
    let horizontalSensitivity = 1.0;
    let verticalSensitivity = 1.0;
    let invertXAxis = false;
    let invertYAxis = false;

    // Variables de suavizado de orientación
    let smoothedOrientation = { alpha: 0, altitude: 0, gamma: 0 };
    let lastRawOrientation = { alpha: 0, altitude: 0, gamma: 0, mappedGamma: 0 };

    // Orientación del dispositivo y offset de calibración
    let deviceOrientation = { alpha: 0, altitude: 0, gamma: 0 };
    let calibrationOffset = { alpha: 0, altitude: 0, gamma: 0 };

    // Array para recolectar muestras durante calibración
    let calibrationSamples = [];

    // Referencias a elementos del DOM
    const video = document.getElementById("video");
    const starfield = document.getElementById("starfield");
    const skyCanvas = document.getElementById("skyCanvas");
    const ctx = skyCanvas.getContext("2d");
    const startPanel = document.getElementById("startPanel");
    const requestPermissionBtn = document.getElementById("requestPermissionBtn");
    const startBtn = document.getElementById("startBtn");
    const controls = document.getElementById("controls");
    const calibrateBtn = document.getElementById("calibrateBtn");
    const resetBtn = document.getElementById("resetBtn");
    const debugToggleBtn = document.getElementById("debugToggleBtn");
    const sensibilityBtn = document.getElementById("sensibilityBtn");
    const objectInfo = document.getElementById("objectInfo");
    const objectName = document.getElementById("objectName");
    const objectDesc = document.getElementById("objectDesc");
    const calibrationUI = document.getElementById("calibrationUI");
    const calibrationDot = document.getElementById("calibrationDot");
    const confirmCalibration = document.getElementById("confirmCalibration");
    const calibMsg = document.getElementById("calibMsg");
    const orientationWarning = document.getElementById("orientationWarning");
    const sensibilityPanel = document.getElementById("sensibilityPanel");
    const horizSensSlider = document.getElementById("horizSensSlider");
    const vertSensSlider = document.getElementById("vertSensSlider");
    const smoothingSlider = document.getElementById("smoothingSlider");
    const invertXSlider = document.getElementById("invertXSlider");
    const invertYSlider = document.getElementById("invertYSlider");
    const horizSensValue = document.getElementById("horizSensValue");
    const vertSensValue = document.getElementById("vertSensValue");
    const smoothingValue = document.getElementById("smoothingValue");
    const closeSettingsBtn = document.getElementById("closeSettingsBtn");
    const debugEl = document.getElementById("debug");

    // Lista de nombres (ejemplo)
    const victimNames = [
      "Saín Álvarez", "Jorge Eliécer García Claro", "Ariel Jaime Arias", "Ramiro Blanco Rubio",
      "Miguel Ángel Carrascal Toro", "Dioselino Durán Pérez", "Guillermo Reyes Aponte", "Alejandro Chocó Cáceres"
    ];

    // Función de inicialización
    function init() {
      if (showDebug) {
        debugEl.textContent = `isIOS: ${isIOS}\nisSafari: ${isSafari}\nAgent: ${navigator.userAgent}`;
      }
      if (isIOS) {
        const debugBtn = document.createElement("button");
        debugBtn.id = "debugBtn";
        debugBtn.textContent = "Debug Mode";
        debugBtn.addEventListener("click", toggleDebug);
        startPanel.appendChild(debugBtn);
      }
      initGyroNorm();
      setupSensibilityPanel();
      checkOrientation();
      debugToggleBtn.addEventListener("click", toggleDebug);
      sensibilityBtn.addEventListener("click", toggleSensibilityPanel);
      window.addEventListener('orientationchange', checkOrientation);
      window.addEventListener('resize', checkOrientation);
      if (isIOS) {
        document.addEventListener('touchmove', function(e) {
          if (!calibrating) e.preventDefault();
        }, { passive: false });
      }
    }

    // Configuración del panel de sensibilidad
    function setupSensibilityPanel() {
      horizSensSlider.value = horizontalSensitivity;
      vertSensSlider.value = verticalSensitivity;
      smoothingSlider.value = smoothingFactor;
      invertXSlider.checked = invertXAxis;
      invertYSlider.checked = invertYAxis;
      horizSensValue.textContent = horizontalSensitivity.toFixed(1);
      vertSensValue.textContent = verticalSensitivity.toFixed(1);
      smoothingValue.textContent = smoothingFactor.toFixed(2);
      horizSensSlider.addEventListener('input', function() {
        horizontalSensitivity = parseFloat(this.value);
        horizSensValue.textContent = horizontalSensitivity.toFixed(1);
      });
      vertSensSlider.addEventListener('input', function() {
        verticalSensitivity = parseFloat(this.value);
        vertSensValue.textContent = verticalSensitivity.toFixed(1);
      });
      smoothingSlider.addEventListener('input', function() {
        smoothingFactor = parseFloat(this.value);
        smoothingValue.textContent = smoothingFactor.toFixed(2);
      });
      invertXSlider.addEventListener('change', function() { invertXAxis = this.checked; });
      invertYSlider.addEventListener('change', function() { invertYAxis = this.checked; });
      closeSettingsBtn.addEventListener('click', function() { sensibilityPanel.style.display = 'none'; });
    }

    // Mostrar/Ocultar panel de sensibilidad
    function toggleSensibilityPanel() {
      sensibilityPanel.style.display = (sensibilityPanel.style.display === 'block') ? 'none' : 'block';
    }

    // Comprobar orientación
    function checkOrientation() {
      const isPortrait = window.innerHeight > window.innerWidth;
      orientationWarning.style.display = isPortrait ? "none" : "flex";
      if (isPortrait) resizeCanvas();
    }

    // Inicializar GyroNorm
    function initGyroNorm() {
      try {
        gn = new GyroNorm();
        const args = {
          frequency: 33,
          gravityNormalized: true,
          orientationBase: GyroNorm.GAME,
          decimalCount: 2,
          logger: function(data) { console.log(data); },
          screenAdjusted: true
        };
        gn.init(args).then(function() {
          console.log("GyroNorm iniciado correctamente");
        }).catch(function(e) {
          console.error("Error al iniciar GyroNorm", e);
          window.addEventListener("deviceorientation", handleOrientation, true);
          window.addEventListener("devicemotion", handleMotion, true);
        });
      } catch (e) {
        console.error("Error creando instancia de GyroNorm", e);
        window.addEventListener("deviceorientation", handleOrientation, true);
        window.addEventListener("devicemotion", handleMotion, true);
      }
    }

    // Función para crear estrellas de fondo (simplificada)
    const BACKGROUND_STAR_COUNT = 400;
    let backgroundStarsArr = [];
    function createBackgroundStars(){
      starfield.innerHTML = "";
      backgroundStarsArr = [];
      for (let i = 0; i < BACKGROUND_STAR_COUNT; i++){
        const az = Math.random() * 360;
        const alt = (Math.asin(2 * Math.random() - 1) * 180) / Math.PI;
        const starEl = document.createElement("div");
        starEl.className = "star";
        const size = Math.random() * 2 + 1;
        starEl.style.width = size + "px";
        starEl.style.height = size + "px";
        starEl.style.opacity = (Math.random() * 0.7 + 0.3).toFixed(2);
        if (Math.random() > 0.9) starEl.classList.add("bright");
        backgroundStarsArr.push({ element: starEl, azimuth: az, altitude: alt });
        starfield.appendChild(starEl);
      }
    }

    // (Opcional) Crear estrellas para "víctimas"
    let victimStars = [];
    function createVictimStars(){
      victimStars = [];
      const placedStars = [];
      const minDistDeg = 10;
      victimNames.forEach(name => {
        let az = Math.random() * 360;
        let alt = -60 + Math.random() * 120;
        placedStars.push({ azimuth: az, altitude: alt, name });
      });
      placedStars.forEach(st => {
        const size = 2 + Math.random() * 2;
        victimStars.push({
          name: st.name,
          azimuth: st.azimuth,
          altitude: st.altitude,
          size: size,
          bright: Math.random() < 0.3,
          connections: []
        });
      });
      victimStars.forEach(st => {
        const starEl = document.createElement("div");
        starEl.className = "star";
        starEl.style.width = st.size + "px";
        starEl.style.height = st.size + "px";
        if (st.bright) starEl.classList.add("bright");
        const nameEl = document.createElement("div");
        nameEl.className = "star-name";
        nameEl.textContent = st.name;
        starfield.appendChild(starEl);
        starfield.appendChild(nameEl);
        st.element = starEl;
        st.nameTag = nameEl;
      });
    }

    // Solicitar permisos (iOS requiere permiso explícito)
    async function requestPermissions() {
      try {
        if (isIOS && typeof DeviceOrientationEvent !== "undefined" &&
            typeof DeviceOrientationEvent.requestPermission === "function") {
          const orientationResponse = await DeviceOrientationEvent.requestPermission();
          if (orientationResponse !== "granted") {
            msgOverlay("Permiso de orientación denegado. Actívalo en Ajustes > Safari > Motion & Orientation Access");
            return false;
          }
        }
        if (isIOS && typeof DeviceMotionEvent !== "undefined" &&
            typeof DeviceMotionEvent.requestPermission === "function") {
          const motionResponse = await DeviceMotionEvent.requestPermission();
          if (motionResponse !== "granted") {
            msgOverlay("Permiso de movimiento denegado. Algunas funciones pueden fallar.");
          }
        }
        initGyroNorm();
        msgOverlay("Permisos concedidos");
        requestPermissionBtn.style.display = "none";
        startBtn.disabled = false;
        return true;
      } catch (error) {
        console.error("Error solicitando permisos:", error);
        msgOverlay("Error solicitando permisos: " + error.message);
        return false;
      }
    }
    requestPermissionBtn.addEventListener("click", requestPermissions);

    // Iniciar la aplicación
    startBtn.addEventListener("click", async () => {
      try {
        checkOrientation();
        if (orientationWarning.style.display === "flex") {
          msgOverlay("Rota tu dispositivo a modo retrato");
          return;
        }
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: "environment", width: { ideal: window.innerWidth }, height: { ideal: window.innerHeight } } 
        });
        video.srcObject = stream;
        video.onloadedmetadata = function() {
          video.play().then(() => {
            startPanel.style.display = "none";
            controls.style.display = "flex";
            resizeCanvas();
            createBackgroundStars();
            createVictimStars();
            appActive = true;
            startCalibration();
            if (gn) {
              gn.start(function(data) {
                processOrientationData(data.do.alpha, data.do.beta - 90, data.do.gamma);
                if (calibrating) updateCalibrationUI();
                if (showDebug) {
                  debugEl.textContent = `
Alpha: ${deviceOrientation.alpha.toFixed(1)}°
Altitud: ${deviceOrientation.altitude.toFixed(1)}°
Gamma: ${deviceOrientation.gamma.toFixed(1)}°
Sens H: ${horizontalSensitivity.toFixed(1)}  V: ${verticalSensitivity.toFixed(1)}
Suavizado: ${smoothingFactor.toFixed(2)}
Offsets => A: ${calibrationOffset.alpha.toFixed(1)}° Alt: ${calibrationOffset.altitude.toFixed(1)}°
Usando: GyroNorm
                  `;
                }
              });
            }
            requestAnimationFrame(updatePositions);
          }).catch(err => {
            console.error("Error al reproducir video:", err);
            msgOverlay("Error iniciando cámara: " + err.message);
          });
        };
      } catch (err) {
        console.error("Error iniciando app:", err);
        msgOverlay("Error iniciando app: " + err.message);
      }
    });

    // Procesar datos de orientación
    function processOrientationData(alpha, altitude, gamma) {
      const gammaClamped = Math.max(-40, Math.min(40, gamma));
      const gammaMapped = (gammaClamped / 40) * 30;
      const alphaDiff = ((alpha - lastRawOrientation.alpha + 540) % 360) - 180;
      const altitudeDiff = altitude - lastRawOrientation.altitude;
      const gammaDiff = gammaMapped - lastRawOrientation.mappedGamma;
      const dirX = invertXAxis ? -1 : 1;
      const dirY = invertYAxis ? -1 : 1;
      const modeX = -1;
      const modeY = -1;
      const adjustedAlpha = lastRawOrientation.alpha + (alphaDiff * horizontalSensitivity * dirX * modeX);
      const adjustedAltitude = lastRawOrientation.altitude + (altitudeDiff * verticalSensitivity * dirY * modeY);
      const adjustedGamma = lastRawOrientation.mappedGamma + (gammaDiff * horizontalSensitivity * dirX * modeX);
      lastRawOrientation.alpha = alpha;
      lastRawOrientation.altitude = altitude;
      lastRawOrientation.gamma = gamma;
      lastRawOrientation.mappedGamma = gammaMapped;
      if (smoothingFactor > 0) {
        if (smoothedOrientation.alpha === 0) {
          smoothedOrientation.alpha = adjustedAlpha;
          smoothedOrientation.altitude = adjustedAltitude;
          smoothedOrientation.gamma = adjustedGamma;
        } else {
          smoothedOrientation.alpha = smoothedOrientation.alpha * smoothingFactor + adjustedAlpha * (1 - smoothingFactor);
          smoothedOrientation.altitude = smoothedOrientation.altitude * smoothingFactor + adjustedAltitude * (1 - smoothingFactor);
          smoothedOrientation.gamma = smoothedOrientation.gamma * smoothingFactor + adjustedGamma * (1 - smoothingFactor);
        }
        deviceOrientation.alpha = smoothedOrientation.alpha;
        deviceOrientation.altitude = smoothedOrientation.altitude;
        deviceOrientation.gamma = smoothedOrientation.gamma;
      } else {
        deviceOrientation.alpha = adjustedAlpha;
        deviceOrientation.altitude = adjustedAltitude;
        deviceOrientation.gamma = adjustedGamma;
      }
      lastOrientationUpdate = Date.now();
    }

    // Handlers de orientación y movimiento para fallback
    function handleOrientation(evt) {
      if (!appActive && !calibrating) return;
      let alpha, beta, gamma;
      if (isIOS) {
        alpha = evt.alpha || 0;
        beta = evt.beta || 0;
        gamma = evt.gamma || 0;
        if (window.orientation === 0 || window.orientation === 180) {
          processOrientationData((360 - alpha) % 360, beta - 90, gamma);
        } else {
          const adjustedGamma = window.orientation === 90 ? gamma : -gamma;
          processOrientationData((360 - alpha) % 360, adjustedGamma, window.orientation === 90 ? beta : -beta);
        }
      } else {
        processOrientationData((360 - (evt.alpha || 0)) % 360, (evt.beta || 0) - 90, evt.gamma || 0);
      }
      if (calibrating) updateCalibrationUI();
      if (showDebug) {
        debugEl.textContent = `
Alpha: ${deviceOrientation.alpha.toFixed(1)}°
Altitud: ${deviceOrientation.altitude.toFixed(1)}°
Gamma: ${deviceOrientation.gamma.toFixed(1)}°
Usando: Eventos nativos
        `;
      }
    }
    function handleMotion(evt) {
      if (!appActive && !calibrating) return;
      if (Date.now() - lastOrientationUpdate > 1000 && (!gn || !gn.isRunning())) {
        const rr = evt.rotationRate;
        if (rr) {
          fallbackOrientation.alpha = (fallbackOrientation.alpha + (rr.alpha || 0) * (evt.timeStamp/1000)) % 360;
          fallbackOrientation.beta = Math.max(-180, Math.min(180, fallbackOrientation.beta + (rr.beta || 0) * (evt.timeStamp/1000)));
          fallbackOrientation.gamma = Math.max(-90, Math.min(90, fallbackOrientation.gamma + (rr.gamma || 0) * (evt.timeStamp/1000)));
          processOrientationData(
            fallbackOrientation.alpha,
            fallbackOrientation.beta - 90,
            fallbackOrientation.gamma
          );
          if (showDebug) {
            debugEl.textContent += "\n[FALLBACK] Usando datos de acelerómetro";
          }
        }
      }
    }

    // Calibración mejorada
    function startCalibration() {
      calibrating = true;
      calibrationUI.style.display = "flex";
      controls.style.pointerEvents = "none";
      // Reiniciar suavizado y vaciar muestras
      smoothedOrientation = { alpha: deviceOrientation.alpha, altitude: deviceOrientation.altitude, gamma: deviceOrientation.gamma };
      calibrationSamples = [];
      updateCalibrationUI();
    }
    
    // Durante calibración, recolectar muestras y actualizar la posición del punto
    function updateCalibrationUI() {
      // Muestra el punto en función de la orientación actual
      const alt = deviceOrientation.altitude;
      const hor = deviceOrientation.gamma;
      const rangeAlt = 60, rangeHor = 60;
      const limitedAlt = Math.max(-rangeAlt, Math.min(rangeAlt, alt));
      const limitedHor = Math.max(-rangeHor, Math.min(rangeHor, hor));
      const radius = 80;
      const x = (limitedHor / rangeHor) * radius;
      const y = -(limitedAlt / rangeAlt) * radius;
      calibrationDot.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
      // Recolectar muestra cada vez que se actualiza (podrías agregar un retardo si fuese necesario)
      calibrationSamples.push({ alpha: deviceOrientation.alpha, altitude: deviceOrientation.altitude, gamma: deviceOrientation.gamma });
    }
    
    // Al confirmar la calibración, se promedian las muestras
    confirmCalibration.addEventListener("click", () => {
      if (calibrationSamples.length > 0) {
        let sum = calibrationSamples.reduce((acc, sample) => {
          return {
            alpha: acc.alpha + sample.alpha,
            altitude: acc.altitude + sample.altitude,
            gamma: acc.gamma + sample.gamma
          };
        }, { alpha: 0, altitude: 0, gamma: 0 });
        calibrationOffset.alpha = sum.alpha / calibrationSamples.length;
        calibrationOffset.altitude = sum.altitude / calibrationSamples.length;
        calibrationOffset.gamma = sum.gamma / calibrationSamples.length;
      }
      calibrationUI.style.display = "none";
      controls.style.pointerEvents = "auto";
      calibrating = false;
      if (video.paused) video.play();
      calibMsg.textContent = "Calibración completa!";
      setTimeout(() => { calibMsg.textContent = ""; }, 2000);
    });
    calibrateBtn.addEventListener("click", startCalibration);
    resetBtn.addEventListener("click", () => {
      if (gn && gn.isRunning()) gn.stop();
      if (stream) stream.getTracks().forEach(t => t.stop());
      window.location.reload();
    });
    function resizeCanvas() {
      skyCanvas.width = window.innerWidth;
      skyCanvas.height = window.innerHeight;
    }
    function toggleDebug() {
      showDebug = !showDebug;
      debugEl.style.display = showDebug ? "block" : "none";
    }
    function calculateScreenPosition(azimuth, altitude) {
      const alpha = (deviceOrientation.alpha - calibrationOffset.alpha + 360) % 360;
      const alt = deviceOrientation.altitude - calibrationOffset.altitude;
      let dAz = azimuth - alpha;
      dAz = ((dAz + 540) % 360) - 180;
      const dAlt = altitude - alt;
      const fovFactor = isIOS ? 2.2 : 2.7;
      const x = window.innerWidth / 2 + (dAz / fovFactor) * (window.innerWidth / 50);
      const y = window.innerHeight / 2 - (dAlt / fovFactor) * (window.innerHeight / 50);
      const inView = (Math.abs(dAz) < 120 && Math.abs(dAlt) < 100);
      return { x, y, inView };
    }
    function updatePositions() {
      if (!appActive || calibrating) {
        requestAnimationFrame(updatePositions);
        return;
      }
      ctx.clearRect(0, 0, skyCanvas.width, skyCanvas.height);
      backgroundStarsArr.forEach(bs => {
        const pos = calculateScreenPosition(bs.azimuth, bs.altitude);
        if (pos.inView) {
          bs.element.style.display = "block";
          bs.element.style.left = pos.x + "px";
          bs.element.style.top = pos.y + "px";
          bs.element.style.opacity = "1";
          bs.element.style.transform = "scale(1)";
        } else {
          bs.element.style.display = "none";
        }
      });
      requestAnimationFrame(updatePositions);
    }
    function msgOverlay(txt) {
      const d = document.createElement("div");
      d.style.position = "fixed";
      d.style.top = "50%";
      d.style.left = "50%";
      d.style.transform = "translate(-50%,-50%)";
      d.style.background = "rgba(0,0,0,0.8)";
      d.style.color = "#fff";
      d.style.padding = "20px";
      d.style.borderRadius = "10px";
      d.style.zIndex = "999";
      d.style.maxWidth = "80%";
      d.style.textAlign = "center";
      d.innerHTML = txt;
      document.body.appendChild(d);
      setTimeout(() => { 
        d.style.opacity = "0";
        d.style.transition = "opacity 0.5s ease";
        setTimeout(() => d.remove(), 500);
      }, 4000);
    }
    // Variables para detección de iOS y Safari
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    // Iniciar
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>